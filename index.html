
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fishing Master Cloud - Street View & Auth</title>
    <meta name="theme-color" content="#0f172a">
    
    <!-- CSS & Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- AI Image Recognition -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #020617; color: white; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Modern Glassmorphism */
        .glass { 
            background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.05); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        #auth-overlay { z-index: 9999; background: #0f172a; }
        /* Custom Leaflet Popup - Transparent Container */
        .leaflet-popup-content-wrapper { background: transparent !important; box-shadow: none !important; border: none !important; padding: 0 !important; }
        .leaflet-popup-tip { display: none; }
        .leaflet-popup-content { margin: 0 !important; width: auto !important; }

        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .weather-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .wind-arrow { transition: transform 1s ease-out; }
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        /* Mobile Scroll Utility */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Snow Animation */
        .snowflake { position: fixed; top: -20px; color: white; pointer-events: none; z-index: 9999; text-shadow: 0 0 2px black; }
        @keyframes fall { to { transform: translateY(110vh); } }
        .snowflake.rain { color: #60a5fa; text-shadow: none; width: 2px; height: 15px; background: #60a5fa; font-size: 0; border-radius: 2px; }

        /* Mobile Optimizations */
        input, button { touch-action: manipulation; }
    </style>
</head>
<body class="overflow-hidden">

    <!-- LOGIN / REGISTER OVERLAY -->
    <div id="auth-overlay" class="fixed inset-0 flex items-center justify-center p-6 hidden">
        <div class="glass w-full max-w-md p-6 md:p-8 rounded-[2rem] shadow-2xl border border-blue-500/20 m-4">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-900/40">
                    <i data-lucide="anchor" class="text-white w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-black tracking-tight">FISHING CLOUD</h2>
                <p class="text-slate-400 text-sm">Masuk untuk simpan spot memancing Anda</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Email</label>
                    <input type="email" id="auth-email" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-4 mt-1 outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Password</label>
                    <input type="password" id="auth-pass" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-4 mt-1 outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="handleAuth('login')" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold transition-all shadow-lg">Masuk Sekarang</button>
                <button onclick="handleAuth('register')" class="w-full py-2 text-slate-400 text-sm hover:text-white">Belum punya akun? Daftar gratis</button>
            </div>
            <p id="auth-error" class="text-red-400 text-xs mt-4 text-center hidden"></p>
        </div>
    </div>

    <!-- MAIN APP CONTENT (Hidden until login) -->
    <div id="app-content" class="">
        <!-- Header Info -->
        <div class="fixed top-4 left-4 right-4 z-[1000] flex justify-between items-start pointer-events-none gap-2">
            <div class="glass p-2 md:p-3 rounded-full md:rounded-2xl flex items-center gap-2 md:gap-3 shadow-lg shadow-black/20 transition-all">
                <div id="user-avatar" class="w-8 h-8 md:w-10 md:h-10 bg-blue-600 rounded-full flex items-center justify-center font-bold text-xs md:text-base shadow-inner">U</div>
                <div class="flex flex-col justify-center">
                    <p class="text-[8px] md:text-[10px] text-slate-400 font-bold uppercase hidden sm:block">Anggota Pro</p>
                    <p id="user-display-email" class="text-[10px] md:text-xs font-medium max-w-[80px] sm:max-w-none truncate">user@mail.com</p>
                </div>
                <button onclick="logout()" class="ml-1 p-1.5 md:p-2 text-red-400 hover:bg-white/5 rounded-full transition-colors"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
            
            <!-- Weather Badge (Global) -->
            <div class="glass px-3 py-2 md:px-4 md:py-2 rounded-full flex items-center gap-2 md:gap-3 pointer-events-auto min-w-0 md:min-w-[140px] shadow-lg shadow-yellow-500/10">
                <div id="user-weather-icon" class="text-yellow-400"><i data-lucide="sun" class="w-4 h-4"></i></div>
                <span id="user-weather-info" class="text-[10px] md:text-xs font-bold text-white whitespace-nowrap">Memuat...</span>
            </div>
        </div>

        <!-- Search Bar (New Feature) -->
        <div class="fixed top-20 left-4 right-4 z-[1000] transition-all duration-300 pointer-events-none">
            <div class="glass rounded-full flex items-center p-2 max-w-md mx-auto shadow-2xl border border-white/10 backdrop-blur-xl pointer-events-auto transform hover:scale-[1.02] transition-transform">
                <button onclick="startVoiceSearch()" id="mic-btn" class="p-2 text-slate-400 hover:text-white transition-colors">
                    <i data-lucide="mic" class="w-4 h-4"></i>
                </button>
                <input type="text" id="search-input" placeholder="Cari lokasi (Desa, Kota, Laut)..." 
                       class="bg-transparent border-none text-sm text-white placeholder-slate-400 focus:outline-none w-full ml-3"
                       onkeypress="handleSearch(event)">
                <button onclick="searchLocation()" id="search-btn" class="p-2 bg-blue-600 rounded-full text-white hover:bg-blue-500 transition-colors shadow-lg shadow-blue-600/30">
                    <i data-lucide="search" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <div id="map"></div>

        <!-- WEATHER & ACTION PANEL (Bottom Sheet) -->
        <div id="location-panel" class="fixed bottom-0 left-0 right-0 z-[1000] translate-y-full transition-transform duration-300 ease-out">
            <div class="glass rounded-t-[2rem] md:rounded-t-[2.5rem] p-5 md:p-6 pb-8 max-w-2xl mx-auto shadow-[0_-10px_40px_rgba(0,0,0,0.5)] border-t border-white/10 max-h-[80vh] overflow-y-auto">
                <!-- Drag Handle -->
                <div class="w-16 h-1.5 bg-slate-600/50 rounded-full mx-auto mb-6 cursor-pointer hover:bg-slate-500 transition-colors" onclick="closeLocationPanel()"></div>
                
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="map-pin" class="text-blue-400 w-5 h-5"></i> <span id="panel-address">Mengambil lokasi...</span>
                        </h3>
                        <p id="panel-coords" class="text-xs text-slate-400 font-mono mt-1">-</p>
                    </div>
                    <button onclick="closeLocationPanel()" class="p-2 bg-slate-800 rounded-full hover:bg-slate-700"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>

                <!-- Weather Grid (Updated to 3x2 for more info) -->
                <!-- Mobile Optimization: Horizontal Scroll (Carousel) -->
                <div class="flex overflow-x-auto gap-3 mb-6 pb-2 no-scrollbar snap-x">
                    <div class="min-w-[100px] snap-center bg-gradient-to-br from-blue-600 to-indigo-600 p-3 rounded-2xl shadow-lg shadow-blue-900/20 text-center relative overflow-hidden flex flex-col justify-center transform transition hover:scale-105">
                        <div class="absolute top-0 right-0 p-1"><i data-lucide="sparkles" class="w-3 h-3 text-yellow-400 animate-pulse"></i></div>
                        <p class="text-[10px] text-blue-100 uppercase font-bold mb-1">AI Score</p>
                        <div class="text-2xl font-black text-white" id="wx-score">--%</div>
                    </div>
                    <div class="min-w-[100px] snap-center bg-slate-800/60 p-3 rounded-2xl border border-white/5 text-center flex flex-col justify-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Suhu</p>
                        <div class="text-2xl font-black text-white" id="wx-temp">--°</div>
                    </div>
                    <div class="min-w-[100px] snap-center bg-slate-800/60 p-3 rounded-2xl border border-white/5 text-center flex flex-col items-center justify-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Angin</p>
                        <div class="flex items-center gap-1">
                            <i data-lucide="arrow-up" id="wx-wind-dir" class="w-4 h-4 text-blue-400 wind-arrow"></i>
                            <span class="text-xl font-bold text-white" id="wx-wind-speed">--</span>
                        </div>
                        <span class="text-[9px] text-slate-500">km/h</span>
                    </div>
                    <div class="min-w-[100px] snap-center bg-slate-800/60 p-3 rounded-2xl border border-white/5 text-center flex flex-col justify-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Cuaca</p>
                        <div class="text-sm font-bold text-blue-300 mt-1" id="wx-desc">Memuat...</div>
                    </div>
                    <div class="min-w-[100px] snap-center bg-slate-800/60 p-3 rounded-2xl border border-white/5 text-center flex flex-col justify-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Ombak (Max)</p>
                        <div class="text-xl font-black text-cyan-300 mt-1" id="wx-wave">-- m</div>
                    </div>
                    <div class="min-w-[100px] snap-center bg-slate-800/60 p-3 rounded-2xl border border-white/5 text-center flex flex-col justify-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Perjalanan</p>
                        <div class="text-sm font-black text-emerald-400 mt-1 leading-tight" id="panel-dist">-- km<br>-- mnt</div>
                    </div>
                    <div class="min-w-[100px] snap-center bg-slate-800/60 p-3 rounded-2xl border border-white/5 text-center flex flex-col justify-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Pasang Surut</p>
                        <div class="text-xl font-black text-purple-300 mt-1" id="wx-tide">-- m</div>
                    </div>
                    <div class="min-w-[100px] snap-center bg-slate-800/60 p-3 rounded-2xl border border-white/5 text-center flex flex-col justify-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Matahari</p>
                        <div class="text-[10px] font-bold text-yellow-300 mt-1 leading-tight" id="wx-sun">--:--<br>--:--</div>
                    </div>
                </div>

                <!-- 7-Day Forecast & Fishing Rating (New Feature) -->
                <div class="mb-6">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><i data-lucide="calendar-days" class="w-3 h-3"></i> Prakiraan 7 Hari & Potensi Mancing</h4>
                    <div id="forecast-list" class="space-y-2"></div>
                </div>

                <!-- Actions -->
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openStreetViewFromPanel()" class="bg-slate-800/80 hover:bg-slate-700 border border-slate-600 py-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-all active:scale-95">
                        <i data-lucide="eye" class="w-4 h-4"></i> Street View
                    </button>
                    <button onclick="openAddModal()" class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 py-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 shadow-lg shadow-blue-900/50 transition-all active:scale-95">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> Simpan Spot
                    </button>
                </div>
            </div>
        </div>

        <!-- Float Action -->
        <div class="fixed bottom-28 md:bottom-24 right-4 md:right-6 z-[900] flex flex-col gap-3 md:gap-4">
            <button onclick="toggleMapLayer()" class="glass p-3 md:p-4 rounded-full text-white shadow-xl hover:scale-110 transition-transform active:scale-90" title="Ganti Peta"><i data-lucide="layers" class="w-5 h-5 md:w-6 md:h-6"></i></button>
            <button onclick="toggleRadar()" id="radar-btn" class="glass p-3 md:p-4 rounded-full text-white shadow-xl hover:scale-110 transition-transform active:scale-90" title="Radar Hujan"><i data-lucide="cloud-rain" class="w-5 h-5 md:w-6 md:h-6"></i></button>
            <button onclick="openFavorites()" class="glass p-3 md:p-4 rounded-full text-red-400 shadow-xl hover:scale-110 transition-transform active:scale-90" title="Favorit Saya"><i data-lucide="heart" class="w-5 h-5 md:w-6 md:h-6 fill-current"></i></button>
            <button onclick="locateUser()" class="glass p-3 md:p-4 rounded-full text-blue-400 shadow-xl hover:scale-110 transition-transform active:scale-90"><i data-lucide="navigation" class="w-5 h-5 md:w-6 md:h-6"></i></button>
        </div>
    </div>

    <!-- MODAL ADD SPOT -->
    <div id="addModal" class="fixed inset-0 z-[10000] bg-black/80 hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-sm p-6 rounded-[2rem] animate-in zoom-in duration-200 m-4 shadow-2xl border border-white/10">
            <h3 id="addModalTitle" class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="map-pin" class="text-blue-500"></i> Tambah Spot</h3>
            <div class="space-y-4">
                <input type="text" id="spotName" placeholder="Nama Spot/Ikan" class="w-full bg-slate-800 border-none rounded-xl p-4 outline-none">
                <div class="flex gap-2">
                    <input type="number" id="spotWeight" placeholder="Berat (Kg)" class="w-1/3 bg-slate-800 border-none rounded-xl p-4 outline-none text-center font-bold text-emerald-400">
                    <input type="number" id="spotRating" min="1" max="5" placeholder="⭐ 1-5" class="w-1/3 bg-slate-800 border-none rounded-xl p-4 outline-none text-center font-bold text-yellow-400">
                    <input type="text" id="spotComment" placeholder="Komentar..." class="w-1/3 bg-slate-800 border-none rounded-xl p-4 outline-none">
                </div>
                
                <!-- Custom File Input (Optional) -->
                <div class="relative group">
                    <input type="file" id="spotPhoto" accept="image/*" class="hidden" onchange="previewImage(this)">
                    <label for="spotPhoto" class="flex flex-col items-center justify-center gap-2 w-full p-6 bg-slate-800/50 rounded-2xl border-2 border-dashed border-slate-600 text-slate-400 cursor-pointer hover:bg-slate-800 hover:border-blue-500 hover:text-blue-400 transition-all group-hover:shadow-lg group-hover:shadow-blue-900/20">
                        <i data-lucide="camera" class="w-8 h-8 mb-1"></i>
                        <span id="photoLabel" class="text-xs font-bold uppercase tracking-wider">Tambah Foto (Opsional)</span>
                    </label>
                    <div id="imagePreviewContainer" class="hidden mt-3 relative rounded-2xl overflow-hidden border border-white/10 shadow-xl">
                        <img id="imagePreview" class="w-full h-48 object-cover">
                        <button onclick="clearImage()" class="absolute top-2 right-2 bg-black/60 backdrop-blur-md p-2 rounded-full text-white hover:bg-red-500 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <!-- Street View Info -->
                <div id="sv-preview" class="bg-slate-900 p-3 rounded-xl border border-slate-700">
                    <p class="text-[10px] text-emerald-400 font-bold uppercase mb-1 flex items-center gap-1">
                        <i data-lucide="eye" class="w-3 h-3"></i> Street View Tersedia
                    </p>
                    <p class="text-[10px] text-slate-500">Koordinat akan dikunci ke lokasi Google Maps.</p>
                </div>

                <button id="btnSaveSpot" onclick="saveSpotCloud()" class="w-full bg-blue-600 py-4 rounded-xl font-bold hover:bg-blue-500 transition-colors shadow-lg shadow-blue-900/50">Simpan ke Cloud</button>
                <button onclick="closeModal()" class="w-full text-slate-500 text-sm">Batal</button>
            </div>
        </div>
    </div>

    <!-- MODAL SPOT DETAIL (New Feature) -->
    <div id="spotDetailModal" class="fixed inset-0 z-[10000] bg-black/90 hidden flex items-center justify-center p-4">
        <div class="bg-slate-950 w-full max-w-lg p-0 rounded-[2.5rem] animate-in zoom-in duration-300 relative m-0 shadow-2xl border border-white/5 overflow-hidden flex flex-col h-[90vh] md:h-auto md:max-h-[85vh]">
            <!-- Header Image -->
            <div class="relative h-72 md:h-80 bg-slate-900 shrink-0 group">
                <img id="detail-img" src="" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/40 to-transparent"></div>
                
                <!-- Favorite Button -->
                <button onclick="toggleFavorite()" id="btn-favorite" class="absolute top-4 right-16 p-3 bg-black/30 rounded-full hover:bg-black/50 text-white backdrop-blur-md border border-white/10 transition-all active:scale-90"><i data-lucide="heart" class="w-6 h-6"></i></button>
                
                <button onclick="closeSpotDetail()" class="absolute top-4 right-4 p-3 bg-black/30 rounded-full hover:bg-black/50 text-white backdrop-blur-md border border-white/10 transition-all active:scale-90"><i data-lucide="x" class="w-6 h-6"></i></button>
                
                <div class="absolute bottom-0 left-0 right-0 p-6 pb-8 bg-gradient-to-t from-slate-950 to-transparent">
                    <h3 class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400 leading-tight drop-shadow-sm" id="detail-name">Nama Spot</h3>
                    <div class="flex items-center gap-3 mt-3">
                        <div class="flex items-center gap-1 text-yellow-400" id="detail-rating-stars"></div>
                        <span class="text-sm font-bold text-slate-400" id="detail-rating-text">(0.0)</span>
                    </div>
                </div>
            </div>
            
            <!-- Content -->
            <div class="px-6 pb-6 overflow-y-auto no-scrollbar flex-1 -mt-4 relative z-10">
                <div class="flex items-center justify-between mb-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-3xl border border-white/5 shadow-xl">
                    <div class="text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">Kontributor</p>
                        <p class="text-2xl font-black text-white" id="detail-count">0</p>
                    </div>
                    <div class="text-center border-l border-white/10 pl-4">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">Rekor Ikan</p>
                        <p class="text-2xl font-black text-emerald-400" id="detail-max-weight">-</p>
                    </div>
                    <button onclick="openStreetViewFromDetail()" class="bg-blue-600/20 border border-blue-500/50 p-3 rounded-xl text-blue-400 hover:bg-blue-600 hover:text-white transition-all"><i data-lucide="eye" class="w-5 h-5"></i></button>
                </div>

                <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 flex items-center gap-2 tracking-wider"><i data-lucide="message-square" class="w-3 h-3"></i> Ulasan & Foto Komunitas</h4>
                <div id="detail-comments" class="space-y-4 pb-20"></div>
            </div>

            <!-- Footer Action -->
            <div class="absolute bottom-0 left-0 right-0 p-4 bg-slate-950/80 backdrop-blur-xl border-t border-white/5 z-20">
                <button onclick="addContribution()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 py-4 rounded-2xl font-bold shadow-lg hover:shadow-blue-500/25 transition-all flex items-center justify-center gap-2 text-white">
                    <i data-lucide="camera" class="w-4 h-4"></i> Tambah Foto / Ulasan Disini
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL WEATHER DETAIL (New Feature) -->
    <div id="weatherDetailModal" class="fixed inset-0 z-[10000] bg-black/80 hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-lg p-6 rounded-[2rem] animate-in zoom-in duration-200 relative m-4 shadow-2xl border border-white/10">
            <button onclick="closeDetailModal()" class="absolute top-4 right-4 p-2 bg-slate-800 rounded-full hover:bg-slate-700"><i data-lucide="x" class="w-4 h-4"></i></button>
            <h3 class="text-xl font-bold mb-1 flex items-center gap-2" id="detail-title">Detail Cuaca</h3>
            <p class="text-xs text-slate-400 mb-6" id="detail-date">...</p>
            
            <!-- Chart Container -->
            <div class="w-full h-48 bg-slate-900/50 rounded-xl border border-slate-700 p-4 relative mb-4" id="chart-container">
                <!-- SVG Chart will be injected here -->
            </div>
            <div class="flex justify-between text-[10px] text-slate-500 px-2 mb-4">
                <span class="flex items-center gap-1"><div class="w-2 h-2 bg-yellow-400 rounded-full"></div> Suhu (°C)</span>
                <span class="flex items-center gap-1"><div class="w-2 h-2 bg-blue-400 rounded-sm"></div> Peluang Hujan (%)</span>
            </div>
            
            <!-- Hourly List -->
            <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Ringkasan Hujan</h4>
            <div class="p-4 bg-slate-800/50 rounded-xl border border-slate-700/50 text-sm text-white" id="rain-summary">
                <!-- Summary -->
            </div>
        </div>
    </div>

    <!-- MODAL FAVORITES LIST -->
    <div id="favoritesModal" class="fixed inset-0 z-[10000] bg-black/80 hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-md p-6 rounded-[2rem] animate-in zoom-in duration-200 m-4 shadow-2xl border border-white/10 flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2 text-white"><i data-lucide="heart" class="text-red-500 fill-red-500"></i> Spot Favorit</h3>
                <button onclick="closeFavorites()" class="p-2 bg-slate-800 rounded-full hover:bg-slate-700 text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div id="favorites-list" class="space-y-3 overflow-y-auto pr-2 no-scrollbar">
                <!-- List items injected here -->
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // 1. KONFIGURASI DATABASE (Google Sheets & ImgBB)
        // Silakan ganti dengan URL Web App Google Script dan API Key ImgBB Anda
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyuRtzzICS1qoBxWKdOJpHeqWCUN6Wt04xAIi_sYQHd0wSxjc89eumDWAYYcKPrT8jV/exec"; 
        const IMGBB_API_KEY = "7e6f3ce63649d305ccaceea00c28266d"; // Daftar gratis di api.imgbb.com

        // --- AI SETUP (MobileNet) ---
        let classifier = null;
        (async () => {
            try {
                classifier = await mobilenet.load();
                console.log("AI Fish Detector Ready");
            } catch (e) { console.log("AI Offline"); }
        })();

        // 2. Map & Street View Setup
        const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
        
        // Cek penyimpanan lokal agar saat refresh langsung ke lokasi terakhir
        const lastLat = localStorage.getItem('lastLat');
        const lastLng = localStorage.getItem('lastLng');
        const initLat = lastLat ? parseFloat(lastLat) : -6.2000;
        const initLng = lastLng ? parseFloat(lastLng) : 106.8166;
        
        var map = L.map('map', { zoomControl: false, layers: [satLayer] }).setView([initLat, initLng], lastLat ? 15 : 13);
        
        let isSat = true;
        function toggleMapLayer() {
            if(isSat) {
                map.removeLayer(satLayer);
                map.addLayer(streetLayer);
            } else {
                map.removeLayer(streetLayer);
                map.addLayer(satLayer);
            }
            isSat = !isSat;
        }

        // --- FITUR BARU: RADAR HUJAN (RainViewer API) ---
        let radarLayer = null;
        let isRadarOn = false;
        let radarInterval = null;
        let radarTimestamps = [];
        let radarCurrentIndex = 0;
        let radarHost = 'https://tile.rainviewer.com'; // Default host

        function toggleRadar() {
            const btn = document.getElementById('radar-btn');
            
            if(isRadarOn) {
                if(radarLayer) map.removeLayer(radarLayer);
                if(radarInterval) clearInterval(radarInterval);
                isRadarOn = false;
                btn.classList.remove('text-blue-400', 'bg-blue-900/50');
                btn.classList.add('text-white');
                
                // Hapus bar progress jika ada
                const bar = document.getElementById('radar-progress');
                if(bar) bar.remove();
            } else {
                // Tampilkan loading
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>';
                
                // Ambil data timestamp terbaru dari RainViewer
                fetch('https://api.rainviewer.com/public/weather-maps.json')
                    .then(res => res.json())
                    .then(data => {
                        if(data.radar && data.radar.past) {
                            if(data.host) radarHost = data.host; // Gunakan host dinamis dari API agar tidak error DNS
                            
                            // Gabungkan data masa lalu (past) dan prediksi (nowcast)
                            radarTimestamps = data.radar.past;
                            if(data.radar.nowcast) {
                                radarTimestamps = [...radarTimestamps, ...data.radar.nowcast];
                            }
                            
                            radarCurrentIndex = radarTimestamps.length - 1; // Mulai dari yang terbaru
                            const latest = radarTimestamps[radarCurrentIndex].time;
                            
                            // Layer Radar
                            // PERBAIKAN: Gunakan host dari API & Hapus path /v2/radar yang salah
                            radarLayer = L.tileLayer(`${radarHost}/${latest}/256/{z}/{x}/{y}/2/1_1.png`, {
                                opacity: 0.6,
                                attribution: 'RainViewer'
                            }).addTo(map);
                            
                            isRadarOn = true;
                            btn.innerHTML = originalIcon; // Kembalikan icon
                            btn.classList.add('text-blue-400', 'bg-blue-900/50');
                            btn.classList.remove('text-white');
                            
                            // Mulai Animasi
                            startRadarAnimation();
                        }
                    })
                    .catch(err => { 
                        console.error(err); 
                        alert("Gagal memuat Radar Hujan (Koneksi/API Error)"); 
                        btn.innerHTML = originalIcon;
                    });
            }
        }

        function startRadarAnimation() {
            if(radarInterval) clearInterval(radarInterval);
            
            // Buat Progress Bar Animasi
            let bar = document.getElementById('radar-progress');
            if(!bar) {
                bar = document.createElement('div');
                bar.id = 'radar-progress';
                bar.className = 'fixed bottom-24 left-20 right-20 h-1 bg-slate-800/50 rounded-full overflow-hidden z-[900] pointer-events-none backdrop-blur-sm';
                bar.innerHTML = '<div id="radar-bar-inner" class="h-full bg-blue-400 w-full transition-all duration-500 shadow-[0_0_10px_rgba(96,165,250,0.8)]"></div>';
                document.body.appendChild(bar);
            }

            radarInterval = setInterval(() => {
                // Loop index
                radarCurrentIndex = (radarCurrentIndex + 1) % radarTimestamps.length;
                const ts = radarTimestamps[radarCurrentIndex].time;
                
                // Update URL Layer
                if(radarLayer) {
                    radarLayer.setUrl(`${radarHost}${pathTemplate.replace('{ts}', ts)}`);
                }
                
                // Update Progress Bar
                const pct = ((radarCurrentIndex + 1) / radarTimestamps.length) * 100;
                const inner = document.getElementById('radar-bar-inner');
                if(inner) inner.style.width = `${pct}%`;
                
            }, 800); // Ganti frame setiap 0.8 detik
        }

        let tempLatlng = null;
        let currentUser = null;
        let searchMarker = null; // Variabel untuk menyimpan marker pencarian
        let selectionMarker = null; // Marker untuk lokasi yang diklik
        let currentUserWeatherCode = null; // Simpan kode cuaca user
        let currentWeatherData = null; // Simpan data cuaca lengkap
        let currentDetailSpot = null; // Data spot yang sedang dibuka detailnya
        let groupedSpots = {}; // Global variable untuk menyimpan data spot yang dikelompokkan

        // Custom Icon untuk Spot Ikan
        const fishIcon = L.divIcon({
            className: 'custom-fish-icon',
            html: `<div class="w-8 h-8 bg-blue-600 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="fish" class="text-white w-5 h-5"></i></div>`,
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        // Fungsi Pencarian Lokasi
        function handleSearch(e) {
            if(e.key === 'Enter') searchLocation();
        }

        function startVoiceSearch() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Browser tidak mendukung fitur suara.");
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.start();
            
            const btn = document.getElementById('mic-btn');
            btn.classList.add('text-red-500', 'animate-pulse');

            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                document.getElementById('search-input').value = text;
                searchLocation();
            };
            recognition.onend = () => btn.classList.remove('text-red-500', 'animate-pulse');
        }

        function searchLocation() {
            const query = document.getElementById('search-input').value;
            if(!query) return;
            
            const btn = document.getElementById('search-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>';

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
                .then(res => res.json())
                .then(data => {
                    if(data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        
                        // 1. Hapus marker pencarian sebelumnya (jika ada) biar map bersih
                        if(searchMarker) map.removeLayer(searchMarker);

                        // 2. Buat Icon Pin Merah ala Google Maps
                        const redPin = L.divIcon({
                            className: 'bg-transparent',
                            html: `<div class="relative -mt-10 flex flex-col items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="46" height="46" viewBox="0 0 24 24" fill="#ef4444" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="drop-shadow-2xl"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3" fill="white"/></svg>
                                    <div class="w-4 h-1.5 bg-black/30 blur-sm rounded-full"></div>
                                   </div>`,
                            iconSize: [46, 46],
                            iconAnchor: [23, 46], // Ujung bawah pin pas di koordinat
                            popupAnchor: [0, -45]
                        });

                        // 3. Tambahkan ke Peta & Buka Popup Nama Lokasi
                        searchMarker = L.marker([lat, lon], {icon: redPin}).addTo(map)
                            .bindPopup(`<b class="text-slate-900 text-sm">${data[0].display_name.split(',')[0]}</b>`).openPopup();

                        map.flyTo([lat, lon], 13);
                    } else {
                        alert("Lokasi tidak ditemukan");
                    }
                })
                .catch(() => alert("Gagal mencari lokasi"))
                .finally(() => btn.innerHTML = originalContent);
        }

        // Fungsi Street View: Membuka koordinat di Google Street View
        function openStreetView(lat, lng) {
            const url = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`;
            window.open(url, '_blank');
        }

        function openStreetViewFromPanel() {
            if(tempLatlng) openStreetView(tempLatlng.lat, tempLatlng.lng);
        }
        
        function openStreetViewFromDetail() {
            if(currentDetailSpot) openStreetView(currentDetailSpot.lat, currentDetailSpot.lng);
        }

        // --- FITUR SALJU (Snow Effect) ---
        let snowInterval = null;
        let isRaining = false;
        
        function startSnow(isRain = false) {
            if(snowInterval && isRaining !== isRain) stopSnow(); // Restart jika tipe berubah
            if(snowInterval) return;
            
            isRaining = isRain;
            const container = document.body;
            snowInterval = setInterval(() => {
                const flake = document.createElement('div');
                flake.classList.add('snowflake');
                if(isRain) flake.classList.add('rain'); else flake.innerHTML = '❄';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.opacity = Math.random() * 0.7 + 0.3;
                flake.style.fontSize = (Math.random() * 10 + 10) + 'px';
                flake.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
                container.appendChild(flake);
                setTimeout(() => flake.remove(), 5000);
            }, 200);
        }

        function stopSnow() {
            if(snowInterval) { clearInterval(snowInterval); snowInterval = null; }
            document.querySelectorAll('.snowflake').forEach(el => el.remove());
        }

        // 3. Auth Logic
        function handleAuth(type) {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errorEl = document.getElementById('auth-error');

            if(!email || !pass) { alert("Isi email & pass!"); return; }

            // Login Sederhana (Tanpa Firebase Auth)
            // Karena pakai Google Sheets, kita hanya butuh Email sebagai identitas pengupload
            console.log("Login berhasil sebagai:", email);
            loginSuccess({ email: email, uid: email });
        }

        // BYPASS LOGIN (Mode Desain) - Langsung masuk otomatis
        // firebase.auth().onAuthStateChanged(user => { if (user) loginSuccess(user); });
        
        setTimeout(() => loginSuccess({ email: 'designer@app.com', uid: 'dev_mode' }), 100);

        function loginSuccess(user) {
            currentUser = user;
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('user-display-email').innerText = user.email;
            document.getElementById('user-avatar').innerText = user.email[0].toUpperCase();
            
            // PERBAIKAN: Refresh ukuran peta agar tidak error/abu-abu saat muncul
            setTimeout(() => { map.invalidateSize(); }, 100);
            
            getUserWeather(); // Ambil cuaca lokasi user saat ini
            loadSpots();
        }

        function logout() {
            location.reload();
        }

        // 4. Spot Management
        
        // Ganti logika klik peta: Munculkan Panel Cuaca dulu
        map.on('click', e => {
            tempLatlng = e.latlng;
            
            // Tambahkan Marker Pin pada lokasi yang diklik
            if (selectionMarker) map.removeLayer(selectionMarker);
            
            const pinIcon = L.divIcon({
                className: 'bg-transparent',
                html: `<div class="relative -mt-8 flex flex-col items-center animate-bounce">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#3b82f6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="drop-shadow-lg"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3" fill="white"/></svg>
                        <div class="w-3 h-1 bg-black/30 blur-sm rounded-full mt-[-2px]"></div>
                       </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });
            selectionMarker = L.marker(e.latlng, {icon: pinIcon}).addTo(map);
            
            showLocationPanel(e.latlng);
        });

        let userLatlng = null;
        // Fitur: Cuaca Realtime di Lokasi User (Header)
        function getUserWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLatlng = L.latLng(lat, lng);
                    
                    // Simpan lokasi ke browser agar refresh selanjutnya instan
                    localStorage.setItem('lastLat', lat);
                    localStorage.setItem('lastLng', lng);
                    
                    // Auto-center map ke lokasi user saat data lokasi didapat
                    map.flyTo([lat, lng], 15);
                    
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
                        const data = await res.json();
                        if(data.current_weather) {
                            const temp = Math.round(data.current_weather.temperature);
                            currentUserWeatherCode = data.current_weather.weathercode;
                            document.getElementById('user-weather-info').innerText = `Lokasi Anda: ${temp}°C`;
                            // Update icon based on weather code could be added here
                            
                            // Cek Salju di lokasi user
                            checkWeatherForSnow(currentUserWeatherCode);
                        }
                    } catch(e) {
                        document.getElementById('user-weather-info').innerText = "Cuaca Offline";
                    }
                }, (err) => {
                    // Handle Error Lokasi (Penting agar user tahu kenapa tidak muncul)
                    console.warn("Geo Error:", err);
                    let msg = "Gagal Lokasi";
                    if(err.code === 1) msg = "Izin Ditolak"; // User menolak izin
                    if(err.code === 3) msg = "Timeout GPS";  // Sinyal lemah
                    document.getElementById('user-weather-info').innerText = msg;
                    
                    // FALLBACK: Jika GPS ditolak/gagal, gunakan estimasi lokasi via IP Address
                    // Ini solusi untuk pengguna baru yang menolak izin lokasi agar tidak stuck di Jakarta
                    fetch('https://ipapi.co/json/')
                        .then(res => res.json())
                        .then(data => {
                            if(data.latitude && data.longitude) {
                                const lat = data.latitude;
                                const lng = data.longitude;
                                
                                // Pindahkan peta ke lokasi IP (Zoom level 12 karena kurang akurat dibanding GPS)
                                map.flyTo([lat, lng], 12);
                                
                                // Simpan estimasi ini agar refresh selanjutnya tetap di area user
                                localStorage.setItem('lastLat', lat);
                                localStorage.setItem('lastLng', lng);
                                
                                document.getElementById('user-weather-info').innerText = `Lokasi: ${data.city} (IP)`;
                            }
                        })
                        .catch(() => console.log("Gagal deteksi lokasi IP"));
                }, { timeout: 10000, enableHighAccuracy: true });
            }
        }

        function checkWeatherForSnow(code) {
            // Kode WMO untuk Salju: 71, 73, 75 (Snow fall), 77 (Snow grains), 85, 86 (Snow showers)
            const snowCodes = [71, 73, 75, 77, 85, 86];
            const rainCodes = [51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99];
            
            if(snowCodes.includes(code)) startSnow(false);
            else if(rainCodes.includes(code)) startSnow(true);
            else stopSnow();
        }

        let currentRouteLine = null; // Menyimpan garis rute

        async function showLocationPanel(latlng) {
            const panel = document.getElementById('location-panel');
            
            // Reset UI
            document.getElementById('panel-address').innerText = "Mencari nama lokasi...";
            document.getElementById('wx-wave').innerText = "-- m";
            document.getElementById('wx-tide').innerText = "-- m";
            document.getElementById('panel-dist').innerHTML = '<span class="animate-pulse">Menghitung...</span>';
            document.getElementById('wx-sun').innerHTML = "--:--<br>--:--";
            document.getElementById('panel-coords').innerText = `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
            document.getElementById('wx-temp').innerText = "--°";
            document.getElementById('wx-wind-speed').innerText = "--";
            document.getElementById('wx-desc').innerText = "Memuat...";
            document.getElementById('wx-score').innerText = "--%";
            document.getElementById('forecast-list').innerHTML = '<div class="text-center text-xs text-slate-500 py-4">Memuat prakiraan...</div>';
            
            // Tampilkan Panel
            panel.classList.remove('translate-y-full');

            // 1. HITUNG RUTE & WAKTU (OSRM Routing)
            if(userLatlng) {
                // Hapus garis rute lama jika ada
                if(currentRouteLine) map.removeLayer(currentRouteLine);

                // Fetch data rute dari OSRM (Gratis)
                fetch(`https://router.project-osrm.org/route/v1/driving/${userLatlng.lng},${userLatlng.lat};${latlng.lng},${latlng.lat}?overview=full&geometries=geojson`)
                    .then(res => res.json())
                    .then(data => {
                        if(data.routes && data.routes.length > 0) {
                            const route = data.routes[0];
                            const distKm = (route.distance / 1000).toFixed(1);
                            const durationSec = route.duration;
                            
                            // Format Waktu (Jam & Menit)
                            const hours = Math.floor(durationSec / 3600);
                            const minutes = Math.floor((durationSec % 3600) / 60);
                            let timeStr = `${minutes} mnt`;
                            if(hours > 0) timeStr = `${hours} jam ${minutes} mnt`;

                            document.getElementById('panel-dist').innerHTML = `${distKm} km<br><span class="text-xs text-slate-300">${timeStr}</span>`;

                            // Gambar Garis Rute di Peta
                            const routeCoords = route.geometry.coordinates.map(c => [c[1], c[0]]); // GeoJSON [lng,lat] -> Leaflet [lat,lng]
                            currentRouteLine = L.polyline(routeCoords, {color: '#3b82f6', weight: 5, opacity: 0.8, lineCap: 'round'}).addTo(map);
                        } else {
                            document.getElementById('panel-dist').innerText = "Tidak ada jalan";
                        }
                    })
                    .catch(() => document.getElementById('panel-dist').innerText = "Gagal hitung");
            }

            // 2. Reverse Geocoding Detail (Nominatim)
            fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latlng.lat}&lon=${latlng.lng}`)
                .then(res => res.json())
                .then(data => {
                    const addr = data.address;
                    
                    // Susun alamat lengkap (Jalan, Desa, Kecamatan, Kota)
                    let parts = [];
                    if(addr.road) parts.push(addr.road);
                    if(addr.village) parts.push(addr.village);
                    else if(addr.hamlet) parts.push(addr.hamlet);
                    if(addr.suburb) parts.push(addr.suburb); // Kecamatan biasanya di sini
                    if(addr.city_district) parts.push(addr.city_district);
                    if(addr.town) parts.push(addr.town);
                    else if(addr.city) parts.push(addr.city);
                    else if(addr.county) parts.push(addr.county); // Kabupaten

                    // Gabungkan dan potong jika terlalu panjang
                    let fullAddr = parts.join(', ');
                    if(fullAddr.length > 45) fullAddr = fullAddr.substring(0, 45) + "...";
                    
                    document.getElementById('panel-address').innerText = fullAddr || "Lokasi Terpilih";
                })
                .catch(() => document.getElementById('panel-address').innerText = "Lokasi Tidak Dikenal");

            // 3. Fetch Weather & Marine Data (Open-Meteo API)
            try {
                // Mengambil Weather + Marine (Wave Height) + Sun (Sunrise/Sunset)
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latlng.lat}&longitude=${latlng.lng}&current_weather=true&hourly=temperature_2m,precipitation_probability,weathercode,wave_height&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,windspeed_10m_max,sunrise,sunset&timezone=auto`);
                const data = await res.json();
                currentWeatherData = data; // Simpan data untuk detail view
                
                if(data.current_weather) {
                    const wx = data.current_weather;
                    document.getElementById('wx-temp').innerText = `${Math.round(wx.temperature)}°`;
                    document.getElementById('wx-wind-speed').innerText = wx.windspeed;
                    
                    // Rotasi panah angin
                    const arrow = document.getElementById('wx-wind-dir');
                    arrow.style.transform = `rotate(${wx.winddirection}deg)`;
                    
                    // Kode cuaca sederhana (WMO code)
                    const code = wx.weathercode;
                    let desc = "Cerah";
                    if(code > 3) desc = "Berawan";
                    if(code > 40) desc = "Kabut";
                    if(code > 50) desc = "Gerimis";
                    if(code > 60) desc = "Hujan";
                    if(code > 80) desc = "Badai";
                    
                    // Cek khusus Salju (Override) agar teksnya benar
                    if([71, 73, 75, 77, 85, 86].includes(code)) desc = "Turun Salju";

                    document.getElementById('wx-desc').innerText = desc;

                    // Cek Salju untuk lokasi yang dipilih
                    checkWeatherForSnow(code);

                    // Ambil data ombak jam sekarang
                    if(data.hourly && data.hourly.wave_height) {
                        const currentHour = new Date().getHours();
                        const waveHeight = data.hourly.wave_height[currentHour] || 0;
                        document.getElementById('wx-wave').innerText = `${waveHeight} m`;
                    }
                    
                    // Data Matahari (Sunrise/Sunset)
                    if(data.daily) {
                        const sunrise = data.daily.sunrise[0].split('T')[1];
                        const sunset = data.daily.sunset[0].split('T')[1];
                        document.getElementById('wx-sun').innerHTML = `🌅 ${sunrise}<br>🌇 ${sunset}`;
                    }

                    // AI Score Calculation
                    let score = 90; // Base score
                    if(wx.windspeed > 15) score -= 10;
                    if(wx.windspeed > 25) score -= 20;
                    if(wx.temperature < 20 || wx.temperature > 32) score -= 10;
                    if(wx.weathercode > 3) score -= 5;
                    if(wx.weathercode > 50) score -= 20;
                    if(wx.weathercode > 80) score -= 40;
                    
                    // Tampilkan Score
                    document.getElementById('wx-score').innerText = `${Math.max(10, score)}%`;

                    // --- FITUR BARU: 7-DAY FORECAST & FISHING RATING ---
                    if(data.daily) {
                        const list = document.getElementById('forecast-list');
                        list.innerHTML = ''; // Clear
                        
                        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                        
                        for(let i=0; i<7; i++) {
                            const date = new Date(data.daily.time[i]);
                            const dayName = i === 0 ? 'Hari Ini' : days[date.getDay()];
                            const maxTemp = Math.round(data.daily.temperature_2m_max[i]);
                            const minTemp = Math.round(data.daily.temperature_2m_min[i]);
                            const rain = data.daily.precipitation_sum[i];
                            const wind = data.daily.windspeed_10m_max[i];
                            const code = data.daily.weathercode[i];

                            // Logika Sederhana Rating Mancing
                            let fishRating = "Bagus";
                            let fishColor = "text-emerald-400";
                            
                            if(wind > 20 || rain > 5) { fishRating = "Sedang"; fishColor = "text-yellow-400"; }
                            if(wind > 30 || rain > 10 || code > 60) { fishRating = "Buruk"; fishColor = "text-red-400"; }

                            const item = document.createElement('div');
                            item.className = "flex items-center justify-between bg-slate-800/30 p-3 rounded-xl border border-white/5 cursor-pointer hover:bg-slate-700/50 transition-colors";
                            item.onclick = () => openDetailModal(i); // Tambahkan event klik
                            item.innerHTML = `
                                <div class="flex items-center gap-3 w-1/3">
                                    <div class="text-xs font-bold text-slate-300">${dayName}</div>
                                </div>
                                <div class="flex items-center gap-2 w-1/3 justify-center">
                                    <i data-lucide="${getWeatherIcon(code)}" class="w-4 h-4 text-blue-300"></i>
                                    <span class="text-xs font-bold">${maxTemp}° / ${minTemp}°</span>
                                </div>
                                <div class="flex flex-col items-end w-1/3">
                                    <span class="text-[10px] font-black uppercase ${fishColor}">${fishRating}</span>
                                    <span class="text-[10px] text-slate-500 flex items-center gap-1">
                                        <i data-lucide="wind" class="w-3 h-3"></i> ${wind} km/h
                                    </span>
                                </div>
                            `;
                            list.appendChild(item);
                        }
                        lucide.createIcons();
                    }
                }
            } catch(err) {
                document.getElementById('wx-desc').innerText = "Offline";
                document.getElementById('wx-temp').innerText = "-";
                document.getElementById('forecast-list').innerHTML = '<div class="text-center text-red-400 text-xs py-4">Gagal memuat data. Cek koneksi internet.</div>';
            }

            // 4. Fetch Tide Data (Marine API)
            try {
                const res = await fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${latlng.lat}&longitude=${latlng.lng}&hourly=tide_height&timezone=auto`);
                const data = await res.json();
                if(data.hourly && data.hourly.tide_height) {
                    const currentHour = new Date().getHours();
                    const tide = data.hourly.tide_height[currentHour] || 0;
                    document.getElementById('wx-tide').innerText = `${tide.toFixed(2)} m`;
                }
            } catch(e) { console.log("Tide data unavailable"); }
        }

        function getWeatherIcon(code) {
            if(code <= 3) return 'sun';
            if(code <= 48) return 'cloud';
            if(code <= 67) return 'cloud-drizzle';
            if(code <= 82) return 'cloud-rain';
            return 'cloud-lightning';
        }

        function closeLocationPanel() {
            document.getElementById('location-panel').classList.add('translate-y-full');
            
            // Hapus rute saat panel ditutup (Pin tetap dibiarkan di peta)
            if (currentRouteLine) {
                map.removeLayer(currentRouteLine);
                currentRouteLine = null;
            }
            
            // Kembalikan efek cuaca ke lokasi user saat panel ditutup
            if(currentUserWeatherCode !== null) {
                checkWeatherForSnow(currentUserWeatherCode);
            } else {
                stopSnow();
            }
        }

        // --- FITUR DETAIL CUACA (Chart & Hourly) ---
        function openDetailModal(dayIndex) {
            if(!currentWeatherData || !currentWeatherData.hourly) return;
            
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const dateStr = currentWeatherData.daily.time[dayIndex];
            const dateObj = new Date(dateStr);
            
            document.getElementById('detail-title').innerText = days[dateObj.getDay()];
            document.getElementById('detail-date').innerText = dateStr;
            
            // Ambil data 24 jam untuk hari tersebut
            const startIndex = dayIndex * 24;
            const hourly = currentWeatherData.hourly;
            
            const temps = [];
            const rains = [];
            const times = [];
            
            for(let i=0; i<24; i++) {
                const idx = startIndex + i;
                if(idx >= hourly.time.length) break;
                temps.push(hourly.temperature_2m[idx]);
                rains.push(hourly.precipitation_probability[idx]);
                times.push(new Date(hourly.time[idx]).getHours());
            }
            
            // Render Chart SVG
            const w = 300, h = 100, pad = 10;
            const minT = Math.min(...temps) - 2;
            const maxT = Math.max(...temps) + 2;
            
            const getX = (i) => pad + (i / 23) * (w - 2 * pad);
            const getYTemp = (t) => h - pad - ((t - minT) / (maxT - minT)) * (h - 2 * pad);
            const getYRain = (p) => h - pad - (p / 100) * (h - 2 * pad);
            
            let pathD = `M ${getX(0)} ${getYTemp(temps[0])}`;
            for(let i=1; i<temps.length; i++) pathD += ` L ${getX(i)} ${getYTemp(temps[i])}`;
            
            let bars = rains.map((r, i) => r > 0 ? `<rect x="${getX(i)-2}" y="${getYRain(r)}" width="4" height="${(h-pad)-getYRain(r)}" fill="#60a5fa" opacity="0.6" rx="1" />` : '').join('');
            let points = temps.map((t, i) => `<circle cx="${getX(i)}" cy="${getYTemp(t)}" r="1.5" fill="#fbbf24" />`).join('');
            let labels = times.map((t, i) => i%4===0 ? `<text x="${getX(i)}" y="${h+5}" font-size="8" fill="#94a3b8" text-anchor="middle">${t}:00</text>` : '').join('');

            document.getElementById('chart-container').innerHTML = `
                <svg viewBox="0 0 ${w} ${h+10}" class="w-full h-full overflow-visible">
                    <line x1="${pad}" y1="${h-pad}" x2="${w-pad}" y2="${h-pad}" stroke="#334155" stroke-width="1" />
                    ${bars}
                    <path d="${pathD}" fill="none" stroke="#fbbf24" stroke-width="2" />
                    ${points}
                    ${labels}
                </svg>
            `;
            
            // Render Summary Hujan
            let rainIntervals = [];
            let start = -1;
            for(let i=0; i<rains.length; i++) {
                if(rains[i] >= 30) { if(start === -1) start = times[i]; }
                else { if(start !== -1) { rainIntervals.push(`${start}:00 - ${times[i]}:00`); start = -1; } }
            }
            if(start !== -1) rainIntervals.push(`${start}:00 - 23:59`);
            
            // Cek tipe presipitasi hari itu (Hujan vs Salju) untuk teks detail
            const dailyCode = currentWeatherData.daily.weathercode[dayIndex];
            const isSnow = [71, 73, 75, 77, 85, 86].includes(dailyCode);

            const summary = rainIntervals.length > 0 
                ? `<div class="flex items-start gap-2"><i data-lucide="${isSnow ? 'snowflake' : 'cloud-rain'}" class="text-blue-400 w-5 h-5 mt-0.5"></i> <div><p class="font-bold text-blue-300">Potensi ${isSnow ? 'Salju' : 'Hujan'} Tinggi (>30%)</p><p>${rainIntervals.join(', ')}</p></div></div>`
                : `<div class="flex items-center gap-2"><i data-lucide="sun" class="text-yellow-400 w-5 h-5"></i> <p>Cuaca cenderung cerah/berawan, kecil kemungkinan hujan.</p></div>`;
            
            document.getElementById('rain-summary').innerHTML = summary;
            
            document.getElementById('weatherDetailModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeDetailModal() {
            document.getElementById('weatherDetailModal').classList.add('hidden');
        }

        // --- FAVORITE SYSTEM ---
        function toggleFavorite() {
            if(!currentDetailSpot) return;
            
            // Gunakan key unik (lat,lng) untuk identifikasi
            const key = currentDetailSpot.lat + ',' + currentDetailSpot.lng;
            let favs = JSON.parse(localStorage.getItem('favorites') || '[]');
            
            // Cek apakah sudah ada
            const index = favs.findIndex(f => (f.lat + ',' + f.lng) === key);
            
            if(index >= 0) {
                favs.splice(index, 1); // Hapus
            } else {
                favs.push(currentDetailSpot); // Tambah
            }
            
            localStorage.setItem('favorites', JSON.stringify(favs));
            updateFavoriteBtn();
        }

        function updateFavoriteBtn() {
            if(!currentDetailSpot) return;
            const key = currentDetailSpot.lat + ',' + currentDetailSpot.lng;
            const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
            const isFav = favs.some(f => (f.lat + ',' + f.lng) === key);
            
            const btn = document.getElementById('btn-favorite');
            if(isFav) {
                btn.innerHTML = '<i data-lucide="heart" class="w-6 h-6 fill-red-500 text-red-500"></i>';
            } else {
                btn.innerHTML = '<i data-lucide="heart" class="w-6 h-6 text-white"></i>';
            }
            lucide.createIcons();
        }

        // --- FAVORITES LIST FUNCTIONS ---
        function openFavorites() {
            const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
            const list = document.getElementById('favorites-list');
            list.innerHTML = '';
            
            if(favs.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 py-8 flex flex-col items-center gap-2"><i data-lucide="heart-off" class="w-8 h-8 opacity-50"></i><p>Belum ada spot favorit.<br>Klik ikon hati pada detail spot untuk menyimpan.</p></div>';
            } else {
                favs.forEach(spot => {
                    const item = document.createElement('div');
                    item.className = "bg-slate-800/50 p-3 rounded-xl border border-white/5 flex items-center gap-3 cursor-pointer hover:bg-slate-700 transition-colors group";
                    item.onclick = () => {
                        closeFavorites();
                        const key = spot.lat + ',' + spot.lng;
                        if(groupedSpots[key]) {
                            openSpotDetail(groupedSpots[key]);
                            map.flyTo([spot.lat, spot.lng], 16);
                        } else {
                            openSpotDetail([spot]);
                            map.flyTo([spot.lat, spot.lng], 16);
                        }
                    };
                    
                    const img = spot.photo || 'https://via.placeholder.com/100?text=Fish';
                    
                    item.innerHTML = `
                        <img src="${img}" class="w-14 h-14 rounded-lg object-cover bg-slate-900 border border-white/10 group-hover:scale-105 transition-transform">
                        <div>
                            <h4 class="font-bold text-sm text-white line-clamp-1">${spot.name}</h4>
                            <p class="text-[10px] text-slate-400 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${parseFloat(spot.lat).toFixed(4)}, ${parseFloat(spot.lng).toFixed(4)}</p>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
            document.getElementById('favoritesModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeFavorites() {
            document.getElementById('favoritesModal').classList.add('hidden');
        }

        // Dictionary Kategori Habitat Ikan (Air Tawar vs Air Asin)
        const fishTranslations = {
            // Kategori Air Tawar
            'tench': 'Ikan Air Tawar', 'goldfish': 'Ikan Air Tawar', 'carp': 'Ikan Air Tawar', 
            'trout': 'Ikan Air Tawar', 'pike': 'Ikan Air Tawar', 'sturgeon': 'Ikan Air Tawar', 
            'gar': 'Ikan Air Tawar', 'bass': 'Ikan Air Tawar', 'catfish': 'Ikan Air Tawar',

            // Kategori Air Asin
            'shark': 'Ikan Air Asin', 'ray': 'Ikan Air Asin', 'stingray': 'Ikan Air Asin', 
            'barracouta': 'Ikan Air Asin', 'marlin': 'Ikan Air Asin', 'anemone': 'Ikan Air Asin', 
            'seahorse': 'Ikan Air Asin', 'whaleshark': 'Ikan Air Asin', 'hammerhead': 'Ikan Air Asin', 
            'lionfish': 'Ikan Air Asin', 'puffer': 'Ikan Air Asin', 'eel': 'Ikan Air Asin', 
            'rock beauty': 'Ikan Air Asin', 'clownfish': 'Ikan Air Asin', 'coho': 'Ikan Air Asin', 
            'crab': 'Hewan Air Asin', 'lobster': 'Hewan Air Asin'
        };

        // --- IMAGE PREVIEW FUNCTIONS ---
        async function previewImage(input) {
            const file = input.files[0];
            if(file) {
                // Auto Deteksi Nama Ikan (Jika input nama masih kosong)
                const nameInput = document.getElementById('spotName');
                if(classifier && nameInput.value.trim() === '') {
                    nameInput.placeholder = "🤖 Menganalisa jenis ikan...";
                    const detectedName = await detectFish(file);
                    if(detectedName) {
                        nameInput.value = detectedName; // Langsung isi kategori
                    }
                    nameInput.placeholder = "Nama Spot/Ikan";
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                    document.getElementById('photoLabel').innerText = "Ganti Foto";
                }
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            document.getElementById('spotPhoto').value = ''; // Reset input file
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('photoLabel').innerText = "Tambah Foto (Opsional)";
        }

        function openAddModal(isContribution = false) {
            closeLocationPanel(); // Tutup panel bawah
            document.getElementById('addModal').classList.remove('hidden');
            
            if(!isContribution) {
                // Reset form jika mode tambah baru
                document.getElementById('spotName').value = '';
                document.getElementById('spotRating').value = '';
                document.getElementById('spotWeight').value = '';
                document.getElementById('spotComment').value = '';
                clearImage();
                document.getElementById('addModalTitle').innerHTML = `<i data-lucide="map-pin" class="text-blue-500"></i> Tambah Spot`;
                document.getElementById('btnSaveSpot').innerText = "Simpan ke Cloud";
            }
        }

        function closeModal() { document.getElementById('addModal').classList.add('hidden'); }

        // Fungsi Validasi Lokasi (Cek apakah Air atau Darat)
        async function checkLocationValidity(lat, lng) {
            try {
                // Gunakan Nominatim untuk cek tipe lokasi
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await res.json();
                
                const type = (data.type || '').toLowerCase();
                const category = (data.category || '').toLowerCase();
                const displayName = (data.display_name || '').toLowerCase();
                
                // 1. Whitelist: Jika terdeteksi air, langsung lolos
                const waterKeywords = ['water', 'lake', 'river', 'sea', 'ocean', 'pond', 'reservoir', 'stream', 'canal', 'bay', 'coast', 'beach', 'dam', 'wetland', 'harbor', 'wharf', 'pier'];
                const idKeywords = ['danau', 'sungai', 'laut', 'pantai', 'waduk', 'kali', 'bendungan', 'embung', 'rawa', 'teluk', 'samudra', 'air', 'dermaga', 'muara'];
                
                if (waterKeywords.includes(type) || waterKeywords.includes(category)) return { valid: true };
                if (waterKeywords.some(k => displayName.includes(k)) || idKeywords.some(k => displayName.includes(k))) return { valid: true };

                // 2. Blacklist: Jika terdeteksi daratan keras (Gunung, Gedung, Jalan)
                const mountainTypes = ['peak', 'volcano', 'mountain', 'hill', 'ridge', 'cliff', 'saddle', 'wood', 'forest', 'grassland'];
                if (mountainTypes.includes(type)) return { valid: false, reason: `Lokasi terdeteksi sebagai ${type} (Daratan/Gunung). Harap pilih lokasi perairan.` };
                
                if (category === 'building') return { valid: false, reason: "Lokasi terdeteksi sebagai Bangunan." };
                
                return { valid: true }; // Lolos jika tidak masuk blacklist (untuk mengakomodasi GPS yang kurang akurat di pinggir sungai)
            } catch(e) { return { valid: true }; } // Skip jika offline
        }

        async function saveSpotCloud() {
            const name = document.getElementById('spotName').value;
            const rating = document.getElementById('spotRating').value;
            const weight = document.getElementById('spotWeight').value;
            const comment = document.getElementById('spotComment').value;
            const fileInput = document.getElementById('spotPhoto');
            const file = fileInput.files[0];
            
            if(!name) { alert("Nama spot wajib diisi!"); return; }

            const btn = document.getElementById('btnSaveSpot');
            const oldText = btn.innerText;
            
            // 0. Validasi Lokasi (Anti-Gunung/Darat)
            btn.innerText = "🌏 Cek Lokasi...";
            btn.disabled = true;
            
            const locCheck = await checkLocationValidity(tempLatlng.lat, tempLatlng.lng);
            if(!locCheck.valid) {
                const proceed = confirm(`⚠️ Peringatan Lokasi\n\n${locCheck.reason}\nSistem mendeteksi ini bukan perairan.\n\nApakah Anda yakin lokasi ini benar (misal: Danau di Gunung)?`);
                if(!proceed) {
                    btn.innerText = oldText;
                    btn.disabled = false;
                    return;
                }
            }
            
            // 1. Validasi AI (Jika ada file & Model siap)
            if(file && classifier) {
                btn.innerText = "🔍 Menganalisa Ikan...";
                btn.disabled = true;

                try {
                    const isFish = await detectFish(file);
                    if(!isFish) {
                        alert("⛔️ Gambar Ditolak!\nSistem AI mendeteksi gambar ini BUKAN IKAN.\n\nMohon unggah foto hasil pancingan yang valid.");
                        btn.innerText = oldText;
                        btn.disabled = false;
                        return; // Stop process
                    }
                } catch(e) {
                    console.error("AI Error:", e);
                }
                btn.innerText = "Menyimpan...";
            }

            // 2. Upload Gambar ke ImgBB (Hosting Gratis)
            let photoUrl = "";
            if (file) {
                btn.innerText = "Mengupload Gambar...";
                try {
                    const formData = new FormData();
                    formData.append("image", file);
                    
                    // Kirim ke ImgBB
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: "POST",
                        body: formData
                    });
                    const data = await res.json();
                    
                    if(data.success) {
                        photoUrl = data.data.url; // Dapat Link Gambar!
                    } else {
                        throw new Error("Gagal upload ke ImgBB");
                    }
                } catch(e) {
                    alert("Gagal upload gambar. Pastikan API Key ImgBB benar.");
                    btn.innerText = "Simpan ke Cloud"; btn.disabled = false;
                    return;
                }
            }

            // 3. Simpan Data ke Google Sheets
            btn.innerText = "Menyimpan ke Sheet...";
            const spotData = {
                name: name,
                lat: tempLatlng.lat,
                lng: tempLatlng.lng,
                photo: photoUrl,
                uid: currentUser.email,
                createdAt: new Date().toISOString(),
                rating: rating,
                comment: comment,
                weight: weight || 0
            };

            // Kirim data ke Google Apps Script
            if(GOOGLE_SCRIPT_URL.startsWith("http")) {
                fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify(spotData)
                }).then(() => {
                    loadSpots(); // Reload semua spot untuk update grouping
                    closeModal();
                    alert("Berhasil disimpan ke Google Sheet!");
                    btn.innerText = "Simpan ke Cloud"; btn.disabled = false;
                }).catch(err => {
                    console.error(err);
                    alert("Gagal koneksi ke Google Sheet. Cek URL Script.");
                    btn.innerText = "Simpan ke Cloud"; btn.disabled = false;
                });
            } else {
                // Fallback LocalStorage jika URL belum diisi
                let local = JSON.parse(localStorage.getItem('spots') || '[]');
                local.push(spotData);
                localStorage.setItem('spots', JSON.stringify(local));
                loadSpots();
                closeModal();
                alert("Disimpan di Local (URL Sheet belum diisi)");
                btn.innerText = "Simpan ke Cloud"; btn.disabled = false;
            }
        }

        function detectFish(file) {
            return new Promise((resolve) => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = async () => {
                    const predictions = await classifier.classify(img);
                    console.log("AI Predictions:", predictions);
                    
                    // Daftar kata kunci ikan/laut dalam bahasa Inggris (MobileNet classes)
                    const fishKeywords = [
                        'fish', 'shark', 'ray', 'eel', 'trout', 'salmon', 'bass', 'pike', 
                        'carp', 'tench', 'barracouta', 'coho', 'gar', 'sturgeon', 'marlin', 'anemone',
                        'seahorse', 'goldfish', 'whaleshark', 'hammerhead', 'crab', 'lobster', 'lionfish'
                    ];
                    
                    // Cek apakah salah satu prediksi mengandung kata kunci
                    const match = predictions.find(p => 
                        fishKeywords.some(k => p.className.toLowerCase().includes(k))
                    );
                    
                    if(match) {
                        // Jika probabilitas rendah (< 20%), kembalikan generic "Ikan" saja
                        if(match.probability < 0.2) {
                            resolve("Ikan (Jenis Tidak Pasti)");
                            return;
                        }

                        let name = match.className.split(',')[0].toLowerCase();
                        // Terjemahkan jika ada di kamus
                        for(const [eng, id] of Object.entries(fishTranslations)) {
                            if(name.includes(eng)) { name = id; break; }
                        }
                        // Format Title Case
                        resolve(name.charAt(0).toUpperCase() + name.slice(1));
                    } else {
                        resolve(null);
                    }
                };
            });
        }

        // Helper: Tentukan Warna & Icon berdasarkan Berat Terbesar
        function getSpotStyle(maxWeight) {
            let colorClass = 'bg-blue-600'; // Default / Kecil (< 3kg)
            let ringClass = 'border-blue-400';
            
            if (maxWeight >= 10) { // Besar (> 10kg) -> MERAH
                colorClass = 'bg-red-600';
                ringClass = 'border-red-400';
            } else if (maxWeight >= 3) { // Sedang (3kg - 10kg) -> KUNING/ORANGE
                colorClass = 'bg-yellow-500';
                ringClass = 'border-yellow-300';
            }

            return L.divIcon({
                className: 'custom-fish-icon',
                html: `<div class="w-8 h-8 ${colorClass} rounded-full border-2 border-white shadow-lg flex items-center justify-center relative">
                        <i data-lucide="fish" class="text-white w-5 h-5"></i>
                        ${maxWeight >= 10 ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-white rounded-full flex items-center justify-center"><div class="w-1.5 h-1.5 bg-red-600 rounded-full animate-ping"></div></div>' : ''}
                       </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        }

        // Fungsi Render Marker (Updated untuk Grouping)
        function addMarker(key, group) {
            // Ambil data utama dari entri pertama atau yang paling baru
            const mainSpot = group[0];
            const count = group.length;
            
            // Hitung rata-rata rating
            let totalRating = 0;
            let ratingCount = 0;
            
            // Cari Berat Terbesar di Spot Ini
            let maxWeight = 0;

            group.forEach(g => {
                if(g.rating) { totalRating += parseInt(g.rating); ratingCount++; }
                if(g.weight) { 
                    const w = parseFloat(g.weight);
                    if(w > maxWeight) maxWeight = w;
                }
            });
            const avgRating = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : "Baru";

            // Cari foto terbaik (yang ada fotonya)
            const coverPhoto = group.find(g => g.photo)?.photo || '';

            // Tentukan Icon berdasarkan Max Weight
            const dynamicIcon = getSpotStyle(maxWeight);

            const popupHtml = `
                <div class="w-64 bg-slate-900/90 backdrop-blur-xl rounded-[1.5rem] border border-white/10 shadow-2xl overflow-hidden pb-1">
                    ${coverPhoto ? `<div class="h-36 w-full relative group cursor-pointer" onclick="openSpotDetailByKey('${key}')">
                        <img src="${coverPhoto}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
                        <div class="absolute top-2 right-2 bg-black/50 backdrop-blur-md px-2 py-1 rounded-lg text-[10px] font-bold text-white flex items-center gap-1"><i data-lucide="image" class="w-3 h-3"></i> ${count}</div>
                    </div>` : '<div class="h-16 bg-gradient-to-r from-blue-600 to-purple-600 relative"><div class="absolute -bottom-6 left-4 w-12 h-12 bg-slate-800 rounded-full border-4 border-slate-900 flex items-center justify-center"><i data-lucide="fish" class="text-blue-400 w-6 h-6"></i></div></div>'}
                    
                    <div class="px-4 pt-3 pb-3">
                        <h4 class="font-black text-lg text-white leading-tight mb-1 truncate">${mainSpot.name}</h4>
                        
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-1 text-xs text-yellow-400 font-bold"><i data-lucide="star" class="w-3 h-3 fill-current"></i> ${avgRating}</div>
                            ${maxWeight > 0 ? `<div class="text-[10px] font-bold text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded-full border border-emerald-500/20">🏆 ${maxWeight} kg</div>` : ''}
                        </div>
                        
                        <button onclick="openSpotDetailByKey('${key}')" class="w-full bg-white/5 hover:bg-white/10 border border-white/10 text-blue-300 hover:text-white text-xs py-2.5 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                            LIHAT DETAIL
                        </button>
                    </div>
                </div>
            `;
            
            L.marker([mainSpot.lat, mainSpot.lng], {icon: dynamicIcon}).addTo(map).bindPopup(popupHtml);
            lucide.createIcons(); // Refresh icon di dalam popup
        }

        // Helper function untuk membuka detail dari popup (menggunakan key global)
        function openSpotDetailByKey(key) {
            if(groupedSpots[key]) {
                openSpotDetail(groupedSpots[key]);
            }
        }

        function openSpotDetail(group) {
            const main = group[0];
            currentDetailSpot = main; // Simpan referensi untuk "Tambah Kontribusi"
            
            // Hitung Stats
            let totalR = 0, countR = 0;
            let maxW = 0;
            group.forEach(g => { if(g.rating) { totalR += parseInt(g.rating); countR++; } });
            group.forEach(g => { if(g.weight && parseFloat(g.weight) > maxW) maxW = parseFloat(g.weight); });
            
            const avg = countR > 0 ? (totalR / countR).toFixed(1) : "0.0";
            
            // Populate UI
            document.getElementById('detail-name').innerText = main.name;
            document.getElementById('detail-count').innerText = group.length;
            document.getElementById('detail-max-weight').innerText = maxW > 0 ? maxW + " kg" : "-";
            document.getElementById('detail-rating-text').innerText = `(${avg} dari ${countR} ulasan)`;
            updateFavoriteBtn(); // Update status tombol favorit
            
            document.getElementById('detail-img').src = group.find(g => g.photo)?.photo || 'https://via.placeholder.com/400x200?text=No+Image';
            
            // Render Stars
            const starsContainer = document.getElementById('detail-rating-stars');
            starsContainer.innerHTML = '';
            for(let i=1; i<=5; i++) {
                starsContainer.innerHTML += `<i data-lucide="star" class="w-4 h-4 ${i <= Math.round(avg) ? 'fill-yellow-400 text-yellow-400' : 'text-slate-600'}"></i>`;
            }

            // Render Comments List
            const list = document.getElementById('detail-comments');
            list.innerHTML = '';
            
            // Urutkan dari yang terbaru
            group.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

            group.forEach(g => {
                const hasPhoto = g.photo ? `<div class="mt-3 rounded-xl overflow-hidden border border-slate-700"><img src="${g.photo}" class="w-full h-auto max-h-64 object-cover" onclick="window.open('${g.photo}')"></div>` : '';
                const stars = g.rating ? `<div class="flex text-yellow-400 my-1">${Array(parseInt(g.rating)).fill('<i data-lucide="star" class="w-3 h-3 fill-current"></i>').join('')}</div>` : '';
                const weightBadge = g.weight && g.weight > 0 ? `<span class="bg-emerald-500/20 text-emerald-400 text-[10px] px-2 py-1 rounded-full border border-emerald-500/30 font-bold ml-2">🐟 ${g.weight} kg</span>` : '';
                
                list.innerHTML += `
                    <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5 shadow-sm mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-slate-700 to-slate-600 flex items-center justify-center text-xs font-bold text-white shadow-inner border border-white/10">
                                    ${g.uid.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-slate-200">${g.uid.split('@')[0]}</p>
                                    <p class="text-[10px] text-slate-400">${new Date(g.createdAt).toLocaleDateString()}</p>
                                </div>
                            </div>
                            ${weightBadge}
                        </div>
                        ${stars}
                        <p class="text-sm text-slate-300 leading-relaxed">${g.comment || ''}</p>
                        ${hasPhoto}
                    </div>
                `;
            });

            document.getElementById('spotDetailModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeSpotDetail() { document.getElementById('spotDetailModal').classList.add('hidden'); }

        function addContribution() {
            if(currentDetailSpot) {
                tempLatlng = { lat: Number(currentDetailSpot.lat), lng: Number(currentDetailSpot.lng) };
                document.getElementById('spotName').value = currentDetailSpot.name;
                document.getElementById('spotWeight').value = ''; // Reset berat untuk kontribusi baru
                
                // Update UI Modal untuk Mode Kontribusi
                document.getElementById('addModalTitle').innerHTML = `<i data-lucide="message-circle" class="text-blue-500"></i> Tambah Ulasan`;
                document.getElementById('btnSaveSpot').innerText = "Kirim Ulasan";
                
                closeSpotDetail();
                openAddModal(true); // Pass true menandakan ini mode kontribusi
            }
        }

        async function loadSpots() {
            // Bersihkan marker lama (kecuali user & search)
            map.eachLayer(layer => {
                if(layer instanceof L.Marker && layer !== searchMarker) {
                    // Cara kasar hapus marker spot ikan tanpa hapus marker lain
                    if(layer.options.icon && layer.options.icon.options.className === 'custom-fish-icon') {
                        map.removeLayer(layer);
                    }
                }
            });

            // 1. Load dari Google Sheets
            if(GOOGLE_SCRIPT_URL.startsWith("http")) {
                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL);
                    const data = await res.json();
                    
                    // GROUPING LOGIC (Reset Global Variable)
                    groupedSpots = {};
                    data.forEach(item => {
                        // Gunakan spotId jika ada, jika tidak (data lama) gunakan lat,lng sebagai key
                        const key = item.spotId || (item.lat + ',' + item.lng);
                        if(!groupedSpots[key]) groupedSpots[key] = [];
                        groupedSpots[key].push(item);
                    });

                    // Render setiap grup
                    Object.keys(groupedSpots).forEach(key => addMarker(key, groupedSpots[key]));
                    
                } catch(e) { console.log("Gagal load Sheet:", e); }
            }
            
            // 2. Load dari LocalStorage (Backup/Demo)
            let local = JSON.parse(localStorage.getItem('spots') || '[]');
            // Simple render for local (no grouping logic implemented for local demo)
            local.forEach(item => {
                const key = item.lat + ',' + item.lng;
                // Tambahkan ke groupedSpots juga agar bisa dibuka detailnya
                if(!groupedSpots[key]) groupedSpots[key] = [];
                groupedSpots[key].push(item);
                // Render (jika belum ada di map dari sheet, tapi disini kita render ulang mungkin duplikat kalau tidak di handle, 
                // tapi asumsi local storage hanya fallback atau data tambahan)
                // Untuk simplifikasi demo:
                addMarker(key, [item]);
            });
        }

        function locateUser() {
            map.locate({setView: true, maxZoom: 15});
        }
        
        map.on('locationfound', e => {
            L.circleMarker(e.latlng, {radius:8, color:'#3b82f6', fillOpacity:0.8}).addTo(map);
        });

    </script>
</body>
</html>
